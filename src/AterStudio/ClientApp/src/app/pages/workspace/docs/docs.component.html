<div *ngIf="isLoading" class="loading">
  <mat-spinner [value]="100">
  </mat-spinner>
</div>

<div *ngIf="!isLoading">
  <mat-toolbar>
    <mat-form-field appearance="fill">
      <mat-select placeholder="选择接口" [(ngModel)]="currentDoc" (selectionChange)="getDocContent()">
        <mat-option *ngFor="let item of docs" [value]="item">
          {{item.name}}
        </mat-option>
      </mat-select>
    </mat-form-field>
    <span>
      <button mat-icon-button matTooltip="添加文档" color="primary" (click)="openAddDocDialog()">
        <mat-icon>note_add</mat-icon>
      </button>
      <button *ngIf="docs.length>0" mat-icon-button matTooltip="删除文档" color="warn" (click)="delete()">
        <mat-icon>delete</mat-icon>
      </button>
    </span>

    <span class="example-spacer"></span>
    <!-- 手动更新 -->
    <button mat-icon-button matTooltip="刷新文档" color="primary" [disabled]="isLoading" (click)="refresh()">
      <mat-icon>refresh</mat-icon>
    </button>
  </mat-toolbar>
  <div class="d-flex">
    <!-- 左边接口树型列表 -->
    <div class="col col-auto api-list" *ngIf="currentDoc!=null">
      <!-- 搜索 -->
      <mat-form-field class="w-100 mt-2">
        <input matInput placeholder="搜索接口" [(ngModel)]="searchKey" (keyup.enter)="filterApis()">
      </mat-form-field>
      <mat-accordion class="example-headers-align" multi>
        <mat-expansion-panel hideToggle [expanded]="true" *ngFor="let group of filterApiGroups">
          <mat-expansion-panel-header>
            <!-- 控制器名(Tag)/描述 -->
            <mat-panel-title>
              <span>{{group.name}} {{group.description}}</span>
            </mat-panel-title>
          </mat-expansion-panel-header>
          <mat-nav-list *ngFor="let api of group.apiInfos" style="margin:0;padding:0">
            <!-- [请求方法] 描述(Route) -->
            <a mat-list-item class="api-item d-flex" (click)="selectApi(api)">
              <div class="request-type" [style.color]="getApiTypeColor(api.operationType!)">
                {{OperationType[api.operationType!].substring(0,1)}}
              </div>
              <div class="d-flex flex-column">
                <span>{{api.summary??api.router}}</span>
              </div>

            </a>
          </mat-nav-list>
        </mat-expansion-panel>
      </mat-accordion>
    </div>
    <!-- 右边内容 -->
    <!-- 请求方法
    路由地址
    描述
    -->
    <div class="col p-2" *ngIf="currentApi">
      <div class="section-block">
        <legend>{{currentApi.summary}}</legend>
        <div class="api-summary">
          <span [style.color]="getApiTypeColor(currentApi.operationType!)">
            {{ OperationType[currentApi.operationType!] }}
          </span>
          <span class="api-router">
            {{currentApi.router}}
          </span>
        </div>
      </div>
      <div class="section-block">
        <legend>请求内容</legend>
        <!-- query -->
        <div *ngIf="currentApi.queryParameters!.length > 0">
          <mat-chip-list>
            <mat-chip color="primary">Query</mat-chip>
          </mat-chip-list>
          <table mat-table #table [dataSource]="currentApi.queryParameters!" class="my-2">
            <ng-container matColumnDef="name">
              <th mat-header-cell *matHeaderCellDef> 名称 </th>
              <td mat-cell *matCellDef="let row"> {{row.name}} </td>
            </ng-container>
            <ng-container matColumnDef="type">
              <th mat-header-cell *matHeaderCellDef> 类型 </th>
              <td mat-cell *matCellDef="let row"> {{row.type}} </td>
            </ng-container>
            <ng-container matColumnDef="requried">
              <th mat-header-cell *matHeaderCellDef> 必须 </th>
              <td mat-cell *matCellDef="let row"> {{row.isRequired?'是':'否'}} </td>
            </ng-container>
            <ng-container matColumnDef="description">
              <th mat-header-cell *matHeaderCellDef> 说明 </th>
              <td mat-cell *matCellDef="let row"> {{row.commentSummary}} </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="tableColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: tableColumns"></tr>
          </table>
        </div>
        <!-- body -->
        <div *ngIf="currentApi.requestInfo">
          <mat-chip-list>
            <mat-chip color="primary">application/json</mat-chip>
            <mat-chip color="primary" selected matTooltip="请求类型">{{currentApi.requestInfo.name}}</mat-chip>
          </mat-chip-list>
          <div *ngIf="currentApi.requestInfo.propertyInfos!.length>0">
            <table mat-table [dataSource]="currentApi.requestInfo.propertyInfos!" class="my-2">
              <!-- 表格模板 -->
              <ng-container matColumnDef="name">
                <th mat-header-cell *matHeaderCellDef> 名称 </th>
                <td mat-cell *matCellDef="let row"> {{row.name}} </td>
              </ng-container>
              <ng-container matColumnDef="type">
                <th mat-header-cell *matHeaderCellDef> 类型 </th>
                <td mat-cell *matCellDef="let row">
                  <ng-container *ngIf="row.isNavigation; else requestPropNav">
                    <strong style="color: #318deb;">
                      {{row.type}}
                    </strong>
                  </ng-container>
                  <ng-template #requestPropNav>
                    {{row.type}}
                  </ng-template>
                </td>
              </ng-container>
              <ng-container matColumnDef="requried">
                <th mat-header-cell *matHeaderCellDef> 必须 </th>
                <td mat-cell *matCellDef="let row"> {{row.isRequired?'是':'否'}} </td>
              </ng-container>
              <ng-container matColumnDef="description">
                <th mat-header-cell *matHeaderCellDef> 说明 </th>
                <td mat-cell *matCellDef="let row"> {{row.commentSummary}} </td>
              </ng-container>
              <!-- 行定义 -->
              <tr mat-header-row *matHeaderRowDef="tableColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: tableColumns" class="example-element-row"
                (click)="showModel(row)"></tr>
            </table>
          </div>
        </div>

      </div>
      <div class="section-block">
        <legend>返回内容</legend>
        <div *ngIf="currentApi.responseInfo">
          <!--  -->
          <ng-container *ngIf="currentApi.responseInfo.propertyInfos!.length>0;else responseElse">
            <mat-chip-list>
              <mat-chip color="primary">application/json</mat-chip>
              <mat-chip color="primary" selected matTooltip="返回类型">{{currentApi.responseInfo.name}}</mat-chip>
            </mat-chip-list>
            <!-- 渲染内容 -->
            <table mat-table [dataSource]="currentApi.responseInfo.propertyInfos!" class="my-2">
              <ng-container matColumnDef="name">
                <th mat-header-cell *matHeaderCellDef> 名称 </th>
                <td mat-cell *matCellDef="let row"> {{row.name}} </td>
              </ng-container>
              <ng-container matColumnDef="type">
                <th mat-header-cell *matHeaderCellDef> 类型 </th>
                <td mat-cell *matCellDef="let row">
                  <ng-container *ngIf="row.isNavigation; else responsePropNav">
                    <strong style="color: #318deb;">
                      {{row.type}}
                    </strong>
                  </ng-container>
                  <ng-template #responsePropNav>
                    {{row.type}}
                  </ng-template>
                </td>
              </ng-container>
              <ng-container matColumnDef="requried">
                <th mat-header-cell *matHeaderCellDef> 必须 </th>
                <td mat-cell *matCellDef="let row"> {{row.isRequired?'是':'否'}} </td>
              </ng-container>
              <ng-container matColumnDef="description">
                <th mat-header-cell *matHeaderCellDef> 说明 </th>
                <td mat-cell *matCellDef="let row"> {{row.commentSummary}} </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="tableColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: tableColumns" class="example-element-row"
                (click)="showModel(row)"></tr>
            </table>
          </ng-container>
          <ng-template #responseElse>
            <mat-chip-list>
              <mat-chip color="primary">application/json</mat-chip>
              <mat-chip color="primary" selected matTooltip="返回类型">{{currentApi.responseInfo.name}}</mat-chip>
            </mat-chip-list>
          </ng-template>
        </div>
      </div>
    </div>
  </div>
</div>
<ng-template #addDocDialog>
  <h2 mat-dialog-title>添加 swagger 接口文档</h2>
  <mat-dialog-content>
    <form [formGroup]="addForm" class="d-flex flex-column">
      <mat-form-field>
        <mat-label>名称</mat-label>
        <input matInput placeholder="文档名称" formControlName="name" required>
      </mat-form-field>
      <mat-form-field>
        <mat-label>描述</mat-label>
        <input matInput placeholder="描述" formControlName="description">
      </mat-form-field>
      <mat-form-field>
        <mat-label>路径</mat-label>
        <input matInput placeholder="swagger.json地址，支持url及本地路径" formControlName="path" required>
      </mat-form-field>
    </form>
  </mat-dialog-content>
  <mat-dialog-actions>
    <button mat-button mat-dialog-close>取消</button>
    <button mat-button (click)="addDoc()" color="primary" [disabled]="isOccupying">添加</button>
  </mat-dialog-actions>
</ng-template>

<ng-template #modelInfo>
  <h2 mat-dialog-title>{{selectedModel?.name}}</h2>
  <mat-dialog-content>
    <table mat-table [dataSource]="selectedModel?.propertyInfos!" class="my-2">
      <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef> 名称 </th>
        <td mat-cell *matCellDef="let row"> {{row.name}} </td>
      </ng-container>
      <ng-container matColumnDef="type">
        <th mat-header-cell *matHeaderCellDef> 类型 </th>
        <td mat-cell *matCellDef="let row">
          <ng-container *ngIf="row.isNavigation; else modelPropNav">
            <strong style="color: #318deb;">
              {{row.type}}
            </strong>
          </ng-container>
          <ng-template #modelPropNav>
            {{row.type}}
          </ng-template>
        </td>
      </ng-container>
      <ng-container matColumnDef="requried">
        <th mat-header-cell *matHeaderCellDef> 必须 </th>
        <td mat-cell *matCellDef="let row"> {{row.isRequired?'是':'否'}} </td>
      </ng-container>
      <ng-container matColumnDef="description">
        <th mat-header-cell *matHeaderCellDef> 说明 </th>
        <td mat-cell *matCellDef="let row"> {{row.commentSummary}} </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="tableColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: tableColumns" class="example-element-row" (click)="showModel(row)"></tr>
    </table>
  </mat-dialog-content>
  <mat-dialog-actions>
    <button mat-button mat-dialog-close>关闭</button>
  </mat-dialog-actions>
</ng-template>